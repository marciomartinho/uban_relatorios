# Contexto do Projeto - Sistema de Relat√≥rios Or√ßament√°rios, Financeiros e Patrimoniais

## Vis√£o Geral
Sistema web desenvolvido em Python/Flask para gerenciamento e gera√ß√£o de relat√≥rios or√ßament√°rios, financeiros e patrimoniais. O sistema importa dados de planilhas Excel para um banco PostgreSQL e disponibiliza relat√≥rios via interface web.

## Stack Tecnol√≥gica
- **Backend**: Python 3.x, Flask (com Blueprints)
- **Banco de Dados**: PostgreSQL 16.9
- **ORM**: SQLAlchemy
- **Frontend**: HTML, CSS (separado), JavaScript (separado)
- **ETL**: Pandas para leitura de Excel e carga no banco
- **Deploy**: Desenvolvimento local, futura implanta√ß√£o no Railway

## Status Atual do Desenvolvimento

### ‚úÖ Conclu√≠do
1. **Estrutura do Projeto**: Criada com organiza√ß√£o modular
2. **Ambiente Virtual**: Configurado com todas as depend√™ncias
3. **Conex√£o com Banco**: M√≥dulo `database.py` implementado e testado
4. **Banco de Dados**: `relatorios_uban` criado no PostgreSQL
5. **Schemas**: Criados (public, receitas, despesas, dimensoes)
6. **Tabelas de Controle ETL**: 
   - `etl_control`: Controla √∫ltima carga de cada tabela
   - `etl_log`: Registra hist√≥rico de todas as cargas
   - Triggers e √≠ndices criados para performance
7. **ETL ReceitaSaldo**: 
   - M√≥dulo `etl_receita_saldo.py` implementado
   - Tabela `receitas.fato_receita_saldo` criada e populada
   - 11.998 registros carregados (Jan-Jun 2025)
   - Transforma√ß√µes aplicadas com sucesso
   - Sistema de carga incremental implementado
8. **ETL DespesaSaldo**:
   - M√≥dulo `etl_despesa_saldo.py` implementado
   - Tabela `despesas.fato_despesa_saldo` criada e populada
   - 560.110 registros carregados (Jan-Jun 2025)
   - Parse de natureza despesa implementado
   - Coluna especial `cosubelemento` para contas de 40 chars
9. **ETL ReceitaLancamento**:
   - M√≥dulo `etl_receita_lancamento.py` implementado
   - Tabela `receitas.fato_receita_lancamento` criada e populada
   - 490.122 registros carregados (2024-01 a 2025-06)
   - Parse de COCONTACORRENTE (17, 38 e 40 chars)
   - Campo `tipo_lancamento` (DEBITO/CREDITO)
   - Sistema de carga incremental implementado
10. **ETL DespesaLancamento**: ‚úÖ NOVO!
    - M√≥dulo `etl_despesa_lancamento.py` implementado
    - Tabela `despesas.fato_despesa_lancamento` criada
    - Preparado para ~1.000.000 registros
    - Parse de COCONTACORRENTE (38 e 40 chars com strip())
    - Campo `tipo_lancamento` baseado em INDEBITOCREDITO
    - Sistema otimizado para grandes volumes
11. **Aplica√ß√£o Flask**: 
    - Servidor web funcionando
    - Sistema de blueprints configurado
    - Templates base e home criados
12. **Interface Web - Consulta Saldo Receita**:
    - P√°gina totalmente funcional
    - Filtros din√¢micos (Ano, Conta, UG)
    - Op√ß√£o "Consolidado" para somar todas UGs
    - Tabela com colunas din√¢micas (17 ou 38 chars)
    - Filtros por coluna tipo Excel
    - Exporta√ß√£o para CSV
    - Formata√ß√£o monet√°ria brasileira
    - Design responsivo com Bootstrap
13. **Interface Web - Consulta Saldo Despesa**:
    - P√°gina totalmente funcional
    - Sistema de cache implementado para performance
    - Corre√ß√£o de bugs SQL realizada
    - √çndices otimizados criados
    - Funciona com 560k+ registros sem travar
    - Ordena√ß√£o por m√™s (Janeiro a Dezembro)
    - Esfera mostra n√∫mero do banco (n√£o texto)
14. **Interface Web - Detalha Conta Cont√°bil Receita**: ‚úÖ NOVO!
    - P√°gina totalmente funcional para an√°lise detalhada de lan√ßamentos
    - Filtros: Ano, Conta Cont√°bil e UG Cont√°bil (com op√ß√£o CONSOLIDADO)
    - Cards de resumo: Total Cr√©ditos, Total D√©bitos, Saldo e Total de Lan√ßamentos
    - Saldo calculado dinamicamente: contas 5* (D√©bito-Cr√©dito), contas 6* (Cr√©dito-D√©bito)
    - Tabela detalhada com colunas: M√™s, Documento, Evento, Conta Corrente, Valor, D/C, UG, Data, Tipo
    - Filtros tipo Excel nas colunas: M√™s, Documento, Evento e Conta Corrente
    - Ordena√ß√£o por m√™s e depois por data
    - Exporta√ß√£o para CSV com resumo no final
    - Valores coloridos: verde para cr√©ditos, vermelho para d√©bitos

### üöÄ Sistema de Cache
- **Tabela**: `public.cache_filtros_despesa`
- **Fun√ß√£o**: Armazena valores √∫nicos de anos, contas e UGs
- **Performance**: Reduz tempo de carregamento de minutos para milissegundos
- **Script**: `scripts/otimizar_despesas.py` para criar/atualizar

### ‚è≥ Em Andamento
- Carregamento inicial de DespesaLancamento (tabela criada, aguardando processamento)
- Interface Web - Detalha Conta Cont√°bil Despesa (pr√≥xima etapa)

### üìã Pr√≥ximas Etapas
- Completar carga inicial de DespesaLancamento
- Criar p√°gina Detalha Conta Cont√°bil Despesa (similar √† de Receita)
- Desenvolver dashboards com gr√°ficos
- Implementar relat√≥rios PDF
- Sistema de autentica√ß√£o

## üìö GUIA DO USU√ÅRIO - Como Atualizar os Dados Mensalmente

### üéØ O que voc√™ vai fazer todo m√™s
Todo m√™s voc√™ vai receber 4 arquivos Excel novos com os dados do m√™s:
- ReceitaSaldoM√™s.xlsx
- DespesaSaldoM√™s.xlsx
- ReceitaLancamentoM√™s.xlsx
- DespesaLancamentoM√™s.xlsx

Voc√™ precisa adicionar esses dados no sistema. √â como adicionar p√°ginas novas em um livro que j√° existe.

### üìÅ PASSO 1: Preparar os Arquivos

1. **Voc√™ vai receber 4 arquivos** (exemplo para Julho):
   - `ReceitaSaldoJulho.xlsx`
   - `DespesaSaldoJulho.xlsx`
   - `ReceitaLancamentoJulho.xlsx`
   - `DespesaLancamentoJulho.xlsx`

2. **Coloque na pasta certa**:
   - Copie esses arquivos para a pasta: `dados_brutos/fato/`
   - √â a mesma pasta onde est√£o os arquivos antigos

3. **IMPORTANTE**: Feche o Excel! N√£o deixe nenhum arquivo aberto no Excel durante o processamento.

### üíª PASSO 2: Abrir o Terminal

1. Abra a pasta do projeto `relatorios_uban` no Windows
2. Clique com bot√£o direito em √°rea vazia
3. Escolha "Abrir no Terminal" ou "Abrir PowerShell aqui"

### üîß PASSO 3: Ativar o Sistema

No terminal, digite e aperte Enter:
```powershell
venv\Scripts\activate
```

**O que vai aparecer**: `(venv)` no in√≠cio da linha

### üìä PASSO 4: Adicionar RECEITA SALDO

Digite e aperte Enter (substitua "Julho" pelo m√™s correto):
```powershell
python scripts/load_receita_saldo_incremental.py ReceitaSaldoJulho.xlsx
```

**O que vai acontecer**:
1. Vai mostrar os per√≠odos encontrados no arquivo
2. Vai perguntar se quer continuar (digite `S` e Enter)
3. Vai processar (demora 1-2 minutos)
4. No final mostra "‚úÖ Carga incremental conclu√≠da com sucesso!"

### üìà PASSO 5: Adicionar DESPESA SALDO

Digite e aperte Enter (substitua "Julho" pelo m√™s correto):
```powershell
python scripts/load_despesa_saldo_incremental.py DespesaSaldoJulho.xlsx
```

**O que vai acontecer**:
1. Mesma coisa que receitas
2. Mas demora mais (5-10 minutos) porque tem mais dados
3. No final mostra "‚úÖ Carga incremental conclu√≠da com sucesso!"

### üìã PASSO 6: Adicionar RECEITA LAN√áAMENTO

Digite e aperte Enter (substitua "Julho" pelo m√™s correto):
```powershell
python scripts/load_receita_lancamento_incremental.py ReceitaLancamentoJulho.xlsx
```

**O que vai acontecer**:
1. Similar aos anteriores
2. Demora uns 5-8 minutos (quase 500 mil registros)
3. No final mostra "‚úÖ Carga incremental conclu√≠da com sucesso!"

### üí∏ PASSO 7: Adicionar DESPESA LAN√áAMENTO ‚úÖ NOVO!

Digite e aperte Enter (substitua "Julho" pelo m√™s correto):
```powershell
python scripts/load_despesa_lancamento_incremental.py DespesaLancamentoJulho.xlsx
```

**O que vai acontecer**:
1. Similar aos anteriores
2. Demora mais (15-25 minutos) porque tem ~1 milh√£o de registros
3. Primeiro l√™ o arquivo todo (1-3 minutos)
4. Depois processa com barra de progresso
5. No final mostra "‚úÖ Carga incremental conclu√≠da com sucesso!"

### ‚ö° PASSO 8: Atualizar o CACHE (MUITO IMPORTANTE!)

**Por que isso √© importante?** O cache √© como um √≠ndice de livro. Se voc√™ n√£o atualizar, o sistema n√£o vai mostrar os novos meses nos filtros!

Digite e aperte Enter:
```powershell
python scripts/otimizar_despesas.py
```

**O que vai acontecer**:
1. Vai recriar a lista de anos, contas e UGs
2. Demora 2-3 minutos
3. No final mostra "‚ú® OTIMIZA√á√ÉO CONCLU√çDA COM SUCESSO!"

### ‚úÖ PASSO 9: Verificar se Funcionou

1. **Inicie o sistema**:
```powershell
python run.py
```

2. **Abra o navegador** em: http://localhost:5000

3. **Teste**:
   - V√° em "Consulta Saldo Receita" ou "Consulta Saldo Despesa"
   - Verifique se o novo m√™s aparece no filtro de Anos

### üìã Ver Hist√≥rico de Importa√ß√µes

Para ver todas as importa√ß√µes j√° feitas, crie e execute:
```powershell
python scripts/consultar_etl_log.py
```

### üÜò Se Der Erro

**"Permission denied" ou "Permiss√£o negada"**:
- FECHE O EXCEL! O arquivo est√° aberto
- Verifique se nenhum programa est√° usando o arquivo

**"Arquivo n√£o encontrado"**:
- Verifique se o nome do arquivo est√° correto
- Verifique se est√° na pasta `dados_brutos/fato/`

**"Per√≠odo j√° existe"**:
- O sistema vai perguntar se quer sobrescrever
- Digite `S` se quiser substituir os dados

**"Erro de conex√£o"**:
- Verifique se est√° conectado na internet
- Verifique se o banco de dados est√° acess√≠vel

### üìù Resumo R√°pido (Cola no Post-it!)

```
TODO M√äS:
1. Copiar 4 arquivos Excel para dados_brutos/fato/
2. FECHAR O EXCEL!!!
3. Abrir PowerShell na pasta do projeto
4. venv\Scripts\activate
5. python scripts/load_receita_saldo_incremental.py ReceitaSaldoMES.xlsx
6. python scripts/load_despesa_saldo_incremental.py DespesaSaldoMES.xlsx
7. python scripts/load_receita_lancamento_incremental.py ReceitaLancamentoMES.xlsx
8. python scripts/load_despesa_lancamento_incremental.py DespesaLancamentoMES.xlsx
9. python scripts/otimizar_despesas.py
10. python run.py (para testar)
```

## Arquitetura do Sistema

### 1. Camada de Dados - CORA√á√ÉO DO SISTEMA üíó
O banco de dados PostgreSQL √© o componente central do sistema, respons√°vel por:
- **Armazenar** todos os dados importados das planilhas Excel
- **Processar** consultas complexas para gera√ß√£o de relat√≥rios
- **Garantir** integridade e consist√™ncia dos dados
- **Controlar** o versionamento atrav√©s de cargas incrementais

#### Estrat√©gia de Carga de Dados
1. **Carga Inicial**: 
   - Dados de Janeiro a Junho 2025 (ou per√≠odo inicial dispon√≠vel)
   - Apaga e recarrega toda a tabela
   - Registra no `etl_control`

2. **Cargas Incrementais**:
   - Dados mensais (Julho, Agosto, etc.)
   - Apenas adiciona novos registros
   - Valida duplicatas por per√≠odo
   - Mant√©m hist√≥rico em `etl_log`

#### Tabelas de Controle ETL
```sql
etl_control: √öltima carga de cada tabela
- tabela_nome: Nome da tabela fato/dimens√£o
- ultimo_periodo_carregado: Ex: "2025-07"
- tipo_ultima_carga: "inicial" ou "incremental"
- total_registros_carregados: Contador acumulado

etl_log: Hist√≥rico detalhado de todas as cargas
- Registra cada execu√ß√£o de ETL
- Permite rastreabilidade completa
- Identifica erros e reprocessamentos

cache_filtros_despesa: Cache para performance
- tipo_filtro: 'ano', 'conta' ou 'ug'
- valor: Valor √∫nico do filtro
- descricao: Descri√ß√£o (para UGs)
- ordem: Para ordena√ß√£o
```

### 2. Estrutura de Diret√≥rios
```
relatorios_uban/
‚îú‚îÄ‚îÄ venv/                    # Ambiente virtual Python
‚îú‚îÄ‚îÄ dados_brutos/           # Planilhas Excel fonte
‚îÇ   ‚îú‚îÄ‚îÄ dimensao/          # Dados dimensionais
‚îÇ   ‚îî‚îÄ‚îÄ fato/              # Dados de fatos (4 arquivos principais)
‚îú‚îÄ‚îÄ app/                    # Aplica√ß√£o Flask
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py        # Inicializa√ß√£o e configura√ß√£o Flask
‚îÇ   ‚îú‚îÄ‚îÄ routes/            # Blueprints de rotas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py        # Rotas principais
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ saldo_receita.py  # P√°gina de receitas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ saldo_despesa.py  # P√°gina de despesas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ detalha_receita.py # P√°gina detalha conta cont√°bil receita ‚úÖ NOVO!
‚îÇ   ‚îú‚îÄ‚îÄ static/            # Assets est√°ticos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ css/          # Arquivos CSS
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ saldo_receita.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ saldo_despesa.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ detalha_receita.css ‚úÖ NOVO!
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ js/           # Arquivos JavaScript
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ base.js
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ saldo_receita.js
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ saldo_despesa.js
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ detalha_receita.js ‚úÖ NOVO!
‚îÇ   ‚îú‚îÄ‚îÄ templates/         # Templates HTML (Jinja2)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.html     # Template base (atualizado com novo menu)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ saldo_receita/ # Templates de receita
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ consulta_saldo_receita.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ saldo_despesa/ # Templates de despesa
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ consulta_saldo_despesa.html
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ detalha_receita/ # Templates detalha receita ‚úÖ NOVO!
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ consulta_detalha_receita.html
‚îÇ   ‚îî‚îÄ‚îÄ modules/           # M√≥dulos reutiliz√°veis
‚îÇ       ‚îú‚îÄ‚îÄ database.py    # Conex√£o e helpers do banco
‚îÇ       ‚îú‚îÄ‚îÄ etl_receita_saldo.py      # ETL de receitas saldo
‚îÇ       ‚îú‚îÄ‚îÄ etl_despesa_saldo.py      # ETL de despesas saldo
‚îÇ       ‚îú‚îÄ‚îÄ etl_receita_lancamento.py # ETL de receitas lan√ßamento
‚îÇ       ‚îî‚îÄ‚îÄ etl_despesa_lancamento.py # ETL de despesas lan√ßamento ‚úÖ NOVO!
‚îú‚îÄ‚îÄ models/                # Modelos SQLAlchemy (ORM)
‚îú‚îÄ‚îÄ config.py             # Configura√ß√µes da aplica√ß√£o
‚îú‚îÄ‚îÄ .env                  # Vari√°veis de ambiente (credenciais)
‚îú‚îÄ‚îÄ run.py                # Entry point da aplica√ß√£o
‚îú‚îÄ‚îÄ scripts/              # Scripts de manuten√ß√£o e setup
‚îÇ   ‚îú‚îÄ‚îÄ load_receita_saldo_incremental.py     # Carga incremental receitas saldo
‚îÇ   ‚îú‚îÄ‚îÄ load_despesa_saldo_incremental.py     # Carga incremental despesas saldo
‚îÇ   ‚îú‚îÄ‚îÄ load_receita_lancamento.py            # Carga inicial receitas lan√ßamento
‚îÇ   ‚îú‚îÄ‚îÄ load_receita_lancamento_incremental.py # Carga incremental receitas lan√ßamento
‚îÇ   ‚îú‚îÄ‚îÄ load_despesa_lancamento.py            # Carga inicial despesas lan√ßamento ‚úÖ NOVO!
‚îÇ   ‚îú‚îÄ‚îÄ load_despesa_lancamento_incremental.py # Carga incremental despesas lan√ßamento ‚úÖ NOVO!
‚îÇ   ‚îú‚îÄ‚îÄ otimizar_despesas.py                  # Otimiza√ß√£o completa (cache + √≠ndices)
‚îÇ   ‚îú‚îÄ‚îÄ inspect_despesa_lancamento.py         # Inspe√ß√£o de estrutura ‚úÖ NOVO!
‚îÇ   ‚îî‚îÄ‚îÄ inspect_campos_lancamentos.py         # Inspe√ß√£o campos das tabelas lan√ßamento ‚úÖ NOVO!
```

### 3. Configura√ß√£o do Banco de Dados
- **Host**: 31.97.128.109:5432
- **Vers√£o**: PostgreSQL 16.9 (Ubuntu)
- **Banco criado**: `relatorios_uban` ‚úÖ
- **Conex√£o**: SQLAlchemy com psycopg2
- **Tabelas de controle**: `etl_control` e `etl_log` ‚úÖ
- **Cache**: `cache_filtros_despesa` ‚úÖ

## ETL ReceitaSaldo - Detalhamento

### Estrutura da Tabela
A tabela `receitas.fato_receita_saldo` possui:
- **Colunas originais**: Dados diretos do Excel
- **Colunas calculadas**: `saldo_contabil_receita` baseado no primeiro d√≠gito de `cocontacontabil`
- **Colunas derivadas**: Parse de `cocontacorrente` baseado no tamanho (17 ou 38 chars)

### Transforma√ß√µes Aplicadas
1. **Saldo Cont√°bil**:
   - Se `cocontacontabil` come√ßa com 5: `saldo = vadebito - vacredito`
   - Se `cocontacontabil` come√ßa com 6: `saldo = vacredito - vadebito`

2. **Parse de COCONTACORRENTE (17 chars)**:
   - `coclasseorc`: chars 1-8
   - `cofonte`: chars 9-18
   - `cocategoriareceita`: char 1
   - `cofontereceita`: chars 1-2
   - `cosubfontereceita`: chars 1-3
   - `corubrica`: chars 1-4
   - `coalinea`: chars 1-6

3. **Parse de COCONTACORRENTE (38 chars)**:
   - `inesfera`: char 1 (esfera do governo)
   - `couo`: chars 2-6 (unidade or√ßament√°ria)
   - `cofuncao`: chars 7-8 (fun√ß√£o)
   - `cosubfuncao`: chars 9-11 (subfun√ß√£o)
   - `coprograma`: chars 12-15 (programa)
   - `coprojeto`: chars 16-19 (projeto/atividade)
   - `cosubtitulo`: chars 20-23 (subt√≠tulo)
   - `cofonte`: chars 24-32 (fonte - unificado com receitas)
   - `conatureza`: chars 33-38 (natureza da despesa)
   - `incategoria`: char 33 (categoria econ√¥mica)
   - `cogrupo`: char 34 (grupo de despesa)
   - `comodalidade`: chars 35-36 (modalidade)
   - `coelemento`: chars 37-38 (elemento de despesa)

## ETL DespesaSaldo - Detalhamento

### Estrutura da Tabela
A tabela `despesas.fato_despesa_saldo` possui estrutura similar √† ReceitaSaldo, com adi√ß√£o de:
- **Parse de CONATUREZA**: Extra√ß√£o de grupo, modalidade e elemento
- **Campo especial**: `cosubelemento` para contas de 40 caracteres (chars 39-40)

## ETL ReceitaLancamento - Detalhamento

### Estrutura da Tabela
A tabela `receitas.fato_receita_lancamento` possui:
- **490.122 registros** carregados
- **Per√≠odo**: Janeiro 2024 a Junho 2025
- **Diferencial**: S√£o lan√ßamentos individuais, n√£o saldos
- **Campo adicional**: `tipo_lancamento` (DEBITO/CREDITO) baseado em INDEBITOCREDITO
- **Documentos**: Campo NUDOCUMENTO identifica cada lan√ßamento
- **Parse completo**: Suporta contas de 17, 38 e 40 caracteres

### Campos da Tabela receitas.fato_receita_lancamento
```sql
-- Campos principais
1. coexercicio (integer NOT NULL) - Ano do exerc√≠cio
2. coug (integer NOT NULL) - C√≥digo da UG
3. nudocumento (varchar(20) NOT NULL) - N√∫mero do documento
4. nulancamento (integer NOT NULL) - N√∫mero do lan√ßamento
5. coevento (integer) - C√≥digo do evento
6. cocontacontabil (bigint) - Conta cont√°bil
7. cocontacorrente (varchar(50)) - Conta corrente (17, 38 ou 40 chars)
8. inmes (integer) - M√™s do lan√ßamento
9. dalancamento (date) - Data do lan√ßamento (ATEN√á√ÉO: nome √© dalancamento, n√£o dtlancamento)
10. valancamento (numeric) - Valor do lan√ßamento
11. indebitocredito (varchar(1)) - Indicador D/C
12. cougcontab (integer) - UG cont√°bil (usado no filtro da p√°gina)
13. tipo_lancamento (varchar(10)) - DEBITO ou CREDITO

-- Campos derivados do parse de cocontacorrente
14-26. Campos de 17 chars (classifica√ß√£o or√ßament√°ria)
27-39. Campos de 38 chars (natureza despesa)
40. cosubelemento (varchar(2)) - Para contas de 40 chars

-- Campos de controle
41. periodo (varchar(7)) - Per√≠odo no formato YYYY-MM
42. data_carga (timestamp) - Data/hora da carga
```

### ‚ö†Ô∏è IMPORTANTE - Erros Comuns e Como Resolver

1. **Nome do campo de data**: O campo √© `dalancamento` (com apenas um 'l'), N√ÉO `dtlancamento`
2. **UG vs UG Cont√°bil**: 
   - No filtro da p√°gina usar: `cougcontab` (UG Cont√°bil)
   - Na tabela mostrar: `coug` (UG)
3. **C√°lculo do Saldo**:
   - Contas come√ßando com 5: Saldo = D√©bitos - Cr√©ditos
   - Contas come√ßando com 6: Saldo = Cr√©ditos - D√©bitos
4. **Ordem de exibi√ß√£o**: Primeiro por m√™s (num√©rico), depois por data

## ETL DespesaLancamento - Detalhamento ‚úÖ NOVO!

### Estrutura da Tabela
A tabela `despesas.fato_despesa_lancamento` possui:
- **Preparada para ~1.000.000 registros**
- **Per√≠odo**: Esperado similar ao ReceitaLancamento
- **Diferencial**: Volume muito maior que receitas
- **Campo adicional**: `tipo_lancamento` (DEBITO/CREDITO) baseado em INDEBITOCREDITO
- **Parse otimizado**: Apenas contas de 38 e 40 caracteres (com strip() autom√°tico)
- **Processamento**: Em chunks de 10.000 registros para otimizar mem√≥ria

### Caracter√≠sticas Especiais
1. **Tratamento de espa√ßos**: Excel adiciona padding, sistema faz strip() autom√°tico
2. **Otimiza√ß√£o para grandes volumes**: Leitura completa + processamento em chunks
3. **√çndices espec√≠ficos**: Adicionados em `conatureza` e `coevento` para performance
4. **Valida√ß√£o de tamanhos**: Log da distribui√ß√£o de tamanhos de COCONTACORRENTE

## Interface Web - Detalha Conta Cont√°bil Receita ‚úÖ NOVO!

### Arquivos Criados
1. **app/routes/detalha_receita.py** - Blueprint com 3 rotas:
   - `/consulta` - P√°gina principal
   - `/api/filtros` - Retorna valores √∫nicos para os filtros
   - `/api/dados` - Retorna lan√ßamentos filtrados
   - `/api/totais` - Retorna totais de d√©bito/cr√©dito e saldo

2. **app/templates/detalha_receita/consulta_detalha_receita.html**:
   - Layout com cards de resumo no topo
   - Tabela detalhada dos lan√ßamentos
   - Modal de loading

3. **app/static/css/detalha_receita.css**:
   - Estilos para cards coloridos
   - Classes para valores positivos/negativos
   - Badges para tipo de lan√ßamento

4. **app/static/js/detalha_receita.js**:
   - Carregamento din√¢mico de filtros
   - Constru√ß√£o da tabela com DataTables
   - Filtros tipo Excel nas colunas
   - Exporta√ß√£o para CSV

### Integra√ß√£o no Sistema
1. **Atualiza√ß√£o do base.html**:
   - Novo menu dropdown "Detalha Conta Cont√°bil"
   - Submenu para Receita (funcional)
   - Submenu para Despesa (desabilitado temporariamente)

2. **Registro no __init__.py**:
   ```python
   from app.routes.detalha_receita import detalha_receita
   app.register_blueprint(detalha_receita, url_prefix='/detalha-receita')
   ```

### Funcionalidades Implementadas
- **Filtros**: Ano, Conta Cont√°bil, UG Cont√°bil (com op√ß√£o CONSOLIDADO)
- **Cards de Resumo**: Total Cr√©ditos, Total D√©bitos, Saldo, Total de Lan√ßamentos
- **F√≥rmula do Saldo**: Mostra dinamicamente (D-C) ou (C-D) baseado na conta
- **Tabela**: M√™s, Documento, Evento, Conta Corrente, Valor, D/C, UG, Data, Tipo
- **Filtros nas Colunas**: M√™s, Documento, Evento e Conta Corrente
- **Ordena√ß√£o**: Por m√™s (num√©rico) e depois por data
- **Cores**: Verde para cr√©ditos, vermelho para d√©bitos
- **Exporta√ß√£o**: CSV com resumo dos totais no final

### Poss√≠veis Problemas e Solu√ß√µes
1. **Erro de sintaxe JavaScript**: Verificar final do arquivo, sem caracteres extras
2. **Campos n√£o encontrados**: Usar `dalancamento` em vez de `dtlancamento`
3. **Filtros n√£o carregam**: Verificar se as queries SQL est√£o corretas
4. **Performance**: Considerar limitar resultados ou implementar pagina√ß√£o server-side

## Scripts de Manuten√ß√£o

### Scripts Principais Ativos
```
# Otimiza√ß√£o e Cache
otimizar_despesas.py              # Cria cache e √≠ndices (executar ap√≥s cada carga)

# Cargas incrementais mensais (4 arquivos)
load_receita_saldo_incremental.py        # Adiciona novos meses de receita saldo
load_despesa_saldo_incremental.py        # Adiciona novos meses de despesa saldo
load_receita_lancamento_incremental.py   # Adiciona novos meses de receita lan√ßamento
load_despesa_lancamento_incremental.py   # Adiciona novos meses de despesa lan√ßamento ‚úÖ NOVO!

# Cargas iniciais (se precisar recarregar)
load_receita_lancamento.py        # Carga inicial de receita lan√ßamento
load_despesa_lancamento.py        # Carga inicial de despesa lan√ßamento ‚úÖ NOVO!

# Inspe√ß√£o de arquivos
inspect_receita_lancamento.py     # Analisa estrutura de arquivo de receita
inspect_despesa_lancamento.py     # Analisa estrutura de arquivo de despesa ‚úÖ NOVO!
inspect_campos_lancamentos.py     # Lista campos das tabelas de lan√ßamento ‚úÖ NOVO!
```

### Scripts Removidos (j√° executados)
- ~~create_schemas.py~~ - Schemas j√° criados
- ~~create_etl_tables.py~~ - Tabelas ETL j√° criadas
- ~~load_receita_saldo.py~~ - Carga inicial j√° feita
- ~~load_despesa_saldo.py~~ - Carga inicial j√° feita

### Tabelas no Banco
```sql
-- Schemas
public                     -- Tabelas de sistema e cache
receitas                   -- Dados de receitas
despesas                   -- Dados de despesas
dimensoes                  -- Futuras tabelas dimens√£o

-- Tabelas de Controle (schema public)
etl_control                -- Controle de cargas por tabela
etl_log                    -- Log detalhado de todas as cargas
cache_filtros_despesa      -- Cache para performance

-- Tabelas Fato
receitas.fato_receita_saldo       -- 11.998 registros (Jan-Jun 2025)
receitas.fato_receita_lancamento  -- 490.122 registros (Jan/2024-Jun/2025)
despesas.fato_despesa_saldo       -- 560.110 registros (Jan-Jun 2025)
despesas.fato_despesa_lancamento  -- Aguardando carga (~1M registros) ‚è≥
```

## Comandos √öteis

### Ativar ambiente virtual
```bash
# Windows PowerShell
venv\Scripts\activate
```

### Rotina Mensal de Atualiza√ß√£o (4 arquivos)
```bash
# 1. Adicionar receitas saldo do m√™s
python scripts/load_receita_saldo_incremental.py ReceitaSaldoMES.xlsx

# 2. Adicionar despesas saldo do m√™s
python scripts/load_despesa_saldo_incremental.py DespesaSaldoMES.xlsx

# 3. Adicionar receitas lan√ßamento do m√™s
python scripts/load_receita_lancamento_incremental.py ReceitaLancamentoMES.xlsx

# 4. Adicionar despesas lan√ßamento do m√™s ‚úÖ NOVO!
python scripts/load_despesa_lancamento_incremental.py DespesaLancamentoMES.xlsx

# 5. Atualizar cache (IMPORTANTE!)
python scripts/otimizar_despesas.py

# 6. Testar sistema
python run.py
```

### Manuten√ß√£o e Corre√ß√µes
```bash
# Ver estrutura de arquivo Excel novo
python scripts/inspect_despesa_lancamento.py

# Carregar dados iniciais (se necess√°rio)
python scripts/load_despesa_lancamento.py

# Inspecionar campos das tabelas
python scripts/inspect_campos_lancamentos.py
```

## Pr√≥ximos Passos Recomendados

1. **Completar carga de DespesaLancamento**:
   - Executar carga inicial
   - Validar dados carregados
   - Testar performance com 1M+ registros

2. **Criar p√°gina Detalha Conta Cont√°bil Despesa**:
   - Copiar estrutura da p√°gina de Receita
   - Ajustar queries para tabela `despesas.fato_despesa_lancamento`
   - Considerar pagina√ß√£o server-side devido ao volume

3. **Criar tabelas dimens√£o**:
   - Dimens√£o Fonte (cofonte)
   - Dimens√£o Conta Cont√°bil (cocontacontabil)
   - Dimens√£o UG (coug, noug)
   - Dimens√£o Natureza Despesa
   - Dimens√£o Evento (coevento)

4. **Desenvolver dashboards**:
   - Totais por per√≠odo
   - Comparativo receita x despesa
   - Evolu√ß√£o temporal
   - An√°lise por UG
   - An√°lise por natureza de despesa

5. **Melhorias de performance**:
   - Criar views materializadas para lan√ßamentos
   - Implementar particionamento por ano
   - Cache de consultas frequentes
   - Considerar √≠ndices adicionais para consultas espec√≠ficas

## Observa√ß√µes Importantes
- O desenvolvedor √© iniciante, ent√£o o c√≥digo deve ser claro e bem comentado
- Prefer√™ncia por explica√ß√µes passo a passo
- Sistema inicialmente local, depois ser√° deployado no Railway
- Dados sens√≠veis (financeiros/patrimoniais) - aten√ß√£o √† seguran√ßa
- **SEMPRE atualizar o cache ap√≥s cargas incrementais!**
- **SEMPRE fechar o Excel antes de processar arquivos!**
- **Campo de data √© `dalancamento`, N√ÉO `dtlancamento`!**

## Contexto de Neg√≥cio
Sistema para gest√£o de relat√≥rios organizacionais com foco em:
- **Relat√≥rios or√ßament√°rios**: An√°lise de planejamento vs realizado
- **Relat√≥rios financeiros**: Fluxo de caixa, receitas e despesas
- **Relat√≥rios patrimoniais**: Evolu√ß√£o de ativos e passivos

### Caracter√≠sticas dos Dados
- **Volume**: 4 planilhas fato principais
  - ReceitaSaldo: ~12k registros/m√™s
  - DespesaSaldo: ~93k registros/m√™s
  - ReceitaLancamento: ~27k registros/m√™s
  - DespesaLancamento: ~170k registros/m√™s (maior volume)
- **Periodicidade**: Dados mensais
- **Hist√≥rico**: Janeiro 2024 a Junho 2025 (lan√ßamentos), Janeiro a Junho 2025 (saldos)
- **Atualiza√ß√µes**: Incrementais mensais (Julho em diante)
- **Transforma√ß√µes**: Parse de strings, c√°lculos de saldo, m√∫ltiplas colunas derivadas

## Decis√µes T√©cnicas Importantes

### Estrat√©gia de ETL
- **Pandas** para ler Excel e manipular dados
- **SQLAlchemy** para gravar no PostgreSQL
- **Chunks**: Processamento em blocos de 5k-10k linhas
- Transforma√ß√µes aplicadas antes da carga
- Valida√ß√µes para evitar duplicatas em cargas incrementais
- **Strip()** autom√°tico em campos de texto para remover padding do Excel

### Performance
- **Cache de filtros**: Tabela dedicada para valores √∫nicos
- **√çndices otimizados**: Por per√≠odo, conta, UG, natureza, evento
- **Processamento em chunks**: Para arquivos grandes (especialmente DespesaLancamento)
- **Leitura otimizada**: Arquivo completo + processamento em blocos

### Organiza√ß√£o de Scripts
- Pasta `scripts/` para manuten√ß√£o e setup
- Separa√ß√£o clara entre aplica√ß√£o (`app/`) e utilit√°rios
- Scripts podem ser executados independentemente
- Nomenclatura clara: load_[tabela]_incremental.py
- Scripts de inspe√ß√£o para an√°lise de novos arquivos

Sistema de Lan√ßamentos com DuckDB
‚úÖ O que fizemos hoje:

Instalamos o DuckDB no ambiente virtual existente
Criamos a estrutura local para armazenar lan√ßamentos:

Pasta: dados_brutos/fato/db_local/
Banco: lancamentos.duckdb


Migramos 1.5 milh√£o de registros do PostgreSQL para DuckDB
Criamos m√≥dulos ETL otimizados para processar Excel direto no DuckDB
Criamos scripts de carga mensal para voc√™ usar todo m√™s

üìÅ Arquivos criados:
relatorios_uban/
‚îú‚îÄ‚îÄ app/modules/
‚îÇ   ‚îú‚îÄ‚îÄ database_duckdb.py              # Conex√£o com DuckDB
‚îÇ   ‚îú‚îÄ‚îÄ etl_lancamento_duckdb.py        # ETL base
‚îÇ   ‚îú‚îÄ‚îÄ etl_receita_lancamento_duckdb.py # ETL receitas
‚îÇ   ‚îî‚îÄ‚îÄ etl_despesa_lancamento_duckdb.py # ETL despesas
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ criar_tabelas_duckdb.py         # Cria estrutura (j√° executado)
‚îÇ   ‚îú‚îÄ‚îÄ migrar_lancamentos_para_duckdb.py # Migra√ß√£o inicial (j√° executado)
‚îÇ   ‚îú‚îÄ‚îÄ load_receita_lancamento_duckdb.py # Carga mensal receitas
‚îÇ   ‚îú‚îÄ‚îÄ load_despesa_lancamento_duckdb.py # Carga mensal despesas
‚îÇ   ‚îî‚îÄ‚îÄ consultar_lancamentos_duckdb.py   # Consultas r√°pidas
‚îî‚îÄ‚îÄ dados_brutos/fato/db_local/
    ‚îî‚îÄ‚îÄ lancamentos.duckdb               # Banco com 1.5M registros
üéØ Como usar MENSALMENTE:
Para carregar ReceitaLancamentoJulho.xlsx:
bash# 1. Ativar ambiente virtual
venv\Scripts\activate

# 2. Carregar receitas
python scripts/load_receita_lancamento_duckdb.py ReceitaLancamentoJulho.xlsx
Para carregar DespesaLancamentoJulho.xlsx:
bashpython scripts/load_despesa_lancamento_duckdb.py DespesaLancamentoJulho.xlsx
Para fazer consultas r√°pidas:
bashpython scripts/consultar_lancamentos_duckdb.py
üöÄ Vantagens do novo sistema:

Performance: DuckDB √© MUITO mais r√°pido para an√°lises locais
Simplicidade: Apenas 1 arquivo .duckdb para backup
Economia: N√£o consome recursos da VPS
Autonomia: Funciona offline, sem depender de internet
Escalabilidade: Suporta bilh√µes de registros facilmente

‚ö†Ô∏è IMPORTANTE - O que N√ÉO muda:

‚úÖ Sistema web continua funcionando normalmente
‚úÖ Tabelas de SALDO continuam no PostgreSQL da VPS
‚úÖ Scripts de saldo (load_receita_saldo_incremental.py, etc) continuam iguais
‚úÖ P√°ginas web de consulta de saldo continuam funcionando